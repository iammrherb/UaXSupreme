/**
 * Enhanced Configuration Generator
 * Generates optimized, vendor-specific 802.1X configurations
 */

window.generateVendorConfig = function(vendor, platform, settings) {
    const generator = new EnhancedConfigGenerator(vendor, platform, settings);
    return generator.generate();
};

class EnhancedConfigGenerator {
    constructor(vendor, platform, settings) {
        this.vendor = vendor;
        this.platform = platform;
        this.settings = settings;
    }
    
    generate() {
        switch (this.vendor) {
            case 'cisco':
                return this.generateCiscoConfig();
            case 'aruba':
                return this.generateArubaConfig();
            case 'juniper':
                return this.generateJuniperConfig();
            default:
                return this.generateGenericConfig();
        }
    }
    
    generateCiscoConfig() {
        const { settings } = this;
        let config = '';
        
        // Check platform
        if (this.platform === 'ios-xe' || this.platform === 'ios') {
            config = this.generateCiscoSwitchConfig();
        } else if (this.platform === 'wlc-9800') {
            config = this.generateCiscoWLCConfig();
        } else {
            config = this.generateCiscoGenericConfig();
        }
        
        return config;
    }
    
    generateCiscoSwitchConfig() {
        const { settings } = this;
        let config = `!
! ${this.vendor.toUpperCase()} ${this.platform.toUpperCase()} 802.1X Configuration
! Generated by Dot1Xer Supreme Enterprise Edition
! Date: ${new Date().toISOString()}
!
! Platform: ${this.platform}
! Deployment Mode: ${settings.authMode}
!

! =====================================
! GLOBAL AAA AND RADIUS CONFIGURATION
! =====================================

! Enable new AAA model
aaa new-model

! Define RADIUS server group
aaa group server radius DOT1X-SERVERS
 server name RADIUS-1
 server name RADIUS-2
 deadtime ${settings.radiusDeadtime || '15'}
 load-balance method least-outstanding batch-size 5

! Configure RADIUS servers
radius server RADIUS-1
 address ipv4 ${settings.radiusServer} auth-port ${settings.radiusAuthPort} acct-port ${settings.radiusAcctPort}
 timeout ${settings.radiusTimeout}
 retransmit ${settings.radiusRetransmit || '3'}
 key ${settings.radiusKey}

radius server RADIUS-2
 address ipv4 ${settings.secondaryServer} auth-port ${settings.secondaryAuthPort} acct-port ${settings.secondaryAcctPort}
 timeout ${settings.radiusTimeout}
 retransmit ${settings.radiusRetransmit || '3'}
 key ${settings.secondaryKey}

! AAA method lists
aaa authentication dot1x default group DOT1X-SERVERS
aaa authorization network default group DOT1X-SERVERS
aaa accounting update newinfo periodic ${settings.accountingUpdate || '1440'}
aaa accounting dot1x default start-stop group DOT1X-SERVERS

! RADIUS VSA attributes
radius-server attribute 6 on-for-login-auth
radius-server attribute 8 include-in-access-req
radius-server attribute 25 access-request include
radius-server attribute 31 mac format ietf upper-case
radius-server attribute 31 send nas-port-detail mac-only
radius-server dead-criteria time 5 tries 3
radius-server vsa send authentication
radius-server vsa send accounting

${settings.useCoa ? `
! Configure RADIUS Change of Authorization (CoA)
aaa server radius dynamic-author
 client ${settings.radiusServer} server-key ${settings.radiusKey}
 client ${settings.secondaryServer} server-key ${settings.secondaryKey}
 port ${settings.coaPort || '1700'}
 auth-type any
` : ''}

${settings.useRadsec ? `
! Configure RadSec (RADIUS over TLS)
crypto pki trustpoint RADSEC-TP
 enrollment terminal
 revocation-check none
 
radius server RADSEC-1
 address ipv4 ${settings.radiusServer} auth-port ${settings.radsecPort || '2083'} acct-port ${settings.radsecPort || '2083'}
 key ${settings.radiusKey}
 tls-server RADSEC-TP
 tls version 1.2
` : ''}

! =====================================
! GLOBAL 802.1X CONFIGURATION
! =====================================

! Enable 802.1X globally
dot1x system-auth-control
dot1x critical eapol

${settings.authMode === 'monitor' ? `
! Monitor mode configuration
authentication display legacy
authentication open
` : settings.authMode === 'closed' ? `
! Closed mode configuration
no authentication open
` : ''}

! =====================================
! INTERFACE CONFIGURATION
! =====================================

interface ${settings.interface}
 description 802.1X Enabled Port
 switchport mode access
 switchport access vlan ${settings.vlanAuth || '1'}
${settings.vlanVoice ? ` switchport voice vlan ${settings.vlanVoice}` : ''}
 
 ! 802.1X configuration
 authentication host-mode ${settings.hostMode}
 authentication order dot1x mab
 authentication priority dot1x mab
 authentication port-control auto
 authentication periodic
 authentication timer reauthenticate server
 
 dot1x pae authenticator
 dot1x timeout tx-period ${settings.txPeriod}
 dot1x timeout quiet-period ${settings.quietPeriod}
 
 mab
 
${settings.enableDeviceTracking ? `
 ! Device tracking
 device-tracking attach-policy IPDT_POLICY
` : ''}
 
${settings.enableDhcpSnooping ? `
 ! DHCP snooping
 ip dhcp snooping limit rate 15
` : ''}
 
 ! Spanning tree optimizations
 spanning-tree portfast
 spanning-tree bpduguard enable

! =====================================
! SECURITY FEATURES
! =====================================

${settings.enableDhcpSnooping ? `
! DHCP Snooping
ip dhcp snooping
ip dhcp snooping vlan ${settings.vlanAuth || '1'}
no ip dhcp snooping information option
` : ''}

${settings.enableDai ? `
! Dynamic ARP Inspection
ip arp inspection vlan ${settings.vlanAuth || '1'}
ip arp inspection validate src-mac dst-mac ip
` : ''}

${settings.enableIpsg ? `
! IP Source Guard
ip verify source
` : ''}

${settings.enableDeviceTracking ? `
! Device Tracking Policy
device-tracking policy IPDT_POLICY
 tracking enable
` : ''}

${settings.useMacsec ? `
! MACsec Configuration
mka policy MACSEC-POLICY
 key-server priority 0
 macsec-cipher-suite gcm-aes-256

interface ${settings.interface}
 mka policy MACSEC-POLICY
 macsec network-link
` : ''}

! =====================================
! VLAN DEFINITIONS
! =====================================

vlan ${settings.vlanAuth || '1'}
 name AUTHENTICATED-VLAN

vlan ${settings.vlanGuest || '999'}
 name GUEST-VLAN

${settings.vlanVoice ? `
vlan ${settings.vlanVoice}
 name VOICE-VLAN
` : ''}

! =====================================
! SHOW COMMANDS FOR VERIFICATION
! =====================================

! show authentication sessions
! show authentication sessions interface <interface>
! show dot1x all
! show radius server-group all
! show device-tracking database
`;
        
        return config;
    }
    
    generateCiscoWLCConfig() {
        const { settings } = this;
        
        return `!
! Cisco Catalyst 9800 WLC 802.1X Configuration
! Generated by Dot1Xer Supreme Enterprise Edition
!

! Create RADIUS server configuration
radius server ${settings.radiusServer}
 address ipv4 ${settings.radiusServer} auth-port ${settings.radiusAuthPort} acct-port ${settings.radiusAcctPort}
 timeout ${settings.radiusTimeout}
 retransmit ${settings.radiusRetransmit || '3'}
 key ${settings.radiusKey}

! Create AAA server group
aaa group server radius DOT1X-SERVERS
 server name ${settings.radiusServer}

! AAA method lists
aaa authentication dot1x default group DOT1X-SERVERS
aaa authorization network default group DOT1X-SERVERS
aaa accounting identity default start-stop group DOT1X-SERVERS

! Configure Policy Profile
wireless profile policy DOT1X-POLICY
 aaa-override
 central switching
 session-timeout 1800
 vlan ${settings.vlanAuth || '1'}
 no shutdown

! Configure WLAN
wlan DOT1X-WLAN 1 DOT1X-SSID
 security dot1x authentication-list default
 security wpa psk set-key ascii 0 ${settings.radiusKey}
 security wpa akm dot1x
 security wpa wpa2
 security wpa wpa2 ciphers aes
 no shutdown
`;
    }
    
    generateArubaConfig() {
        const { settings } = this;
        
        return `!
! Aruba ${this.platform.toUpperCase()} 802.1X Configuration
! Generated by Dot1Xer Supreme Enterprise Edition
!

! Configure RADIUS servers
radius-server host ${settings.radiusServer} key ${settings.radiusKey}
radius-server host ${settings.secondaryServer} key ${settings.secondaryKey}

! Create server group
aaa group server radius DOT1X-SERVERS
    server ${settings.radiusServer}
    server ${settings.secondaryServer}

! Configure authentication
aaa authentication port-access dot1x authenticator
aaa authentication port-access mac-auth
    
! Enable port access
aaa port-access authenticator active

! Configure interface
interface ${settings.interface}
    aaa authentication port-access dot1x authenticator
    aaa authentication port-access mac-auth
    aaa authentication port-access client-limit ${settings.hostMode === 'multi-auth' ? '256' : '1'}
    aaa authentication port-access reauth-period ${settings.reauthPeriod}
    aaa authentication port-access quiet-period ${settings.quietPeriod}
    aaa authentication port-access tx-period ${settings.txPeriod}
    aaa authentication port-access supplicant-timeout 30
    aaa authentication port-access max-requests 2
    
! Enable VLANs
vlan ${settings.vlanAuth || '1'}
    name "AUTHENTICATED-VLAN"
    
vlan ${settings.vlanGuest || '999'}
    name "GUEST-VLAN"
    
! Show commands
! show port-access clients
! show port-access authenticator statistics
! show radius authentication
`;
    }
    
    generateJuniperConfig() {
        const { settings } = this;
        
        return `# 
# Juniper ${this.platform.toUpperCase()} 802.1X Configuration
# Generated by Dot1Xer Supreme Enterprise Edition
#

# Configure RADIUS servers
set access radius-server ${settings.radiusServer} port ${settings.radiusAuthPort}
set access radius-server ${settings.radiusServer} accounting-port ${settings.radiusAcctPort}
set access radius-server ${settings.radiusServer} secret ${settings.radiusKey}
set access radius-server ${settings.radiusServer} timeout ${settings.radiusTimeout}
set access radius-server ${settings.radiusServer} retry ${settings.radiusRetransmit || '3'}

# Configure access profile
set access profile DOT1X-PROFILE authentication-order [radius]
set access profile DOT1X-PROFILE radius authentication-server ${settings.radiusServer}
set access profile DOT1X-PROFILE radius accounting-server ${settings.radiusServer}

# Configure 802.1X
set protocols dot1x authenticator authentication-profile-name DOT1X-PROFILE
set protocols dot1x authenticator interface ${settings.interface}

# Interface configuration
set interfaces ${settings.interface} unit 0 family ethernet-switching interface-mode access
set protocols dot1x authenticator interface ${settings.interface} supplicant ${settings.hostMode}
set protocols dot1x authenticator interface ${settings.interface} guest-vlan ${settings.vlanGuest || 'guest'}
set protocols dot1x authenticator interface ${settings.interface} server-reject-vlan ${settings.vlanGuest || 'guest'}

# VLAN configuration
set vlans AUTHENTICATED vlan-id ${settings.vlanAuth || '1'}
set vlans GUEST vlan-id ${settings.vlanGuest || '999'}

# Show commands
# show dot1x interface
# show dot1x statistics
# show network-access aaa-statistics
`;
    }
    
    generateGenericConfig() {
        return `!
! Generic 802.1X Configuration
! Vendor: ${this.vendor}
! Platform: ${this.platform}
!

! RADIUS Server Configuration
! Primary Server: ${this.settings.radiusServer}
! Secondary Server: ${this.settings.secondaryServer}
! Auth Port: ${this.settings.radiusAuthPort}
! Acct Port: ${this.settings.radiusAcctPort}

! 802.1X Settings
! Interface: ${this.settings.interface}
! Host Mode: ${this.settings.hostMode}
! Auth Mode: ${this.settings.authMode}

! VLAN Configuration
! Authenticated VLAN: ${this.settings.vlanAuth}
! Guest VLAN: ${this.settings.vlanGuest}
! Voice VLAN: ${this.settings.vlanVoice}

! Timing Configuration
! Reauth Period: ${this.settings.reauthPeriod}
! TX Period: ${this.settings.txPeriod}
! Quiet Period: ${this.settings.quietPeriod}

! Please consult your vendor's documentation for specific syntax
`;
    }
}
